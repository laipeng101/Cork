name: Build Latest Stable Cork

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1' # æ¯å‘¨ä¸€è‡ªåŠ¨æ£€æŸ¥æ›´æ–°

jobs:
  build-stable:
    # ä¾ç„¶ä½¿ç”¨ macOS 26 (Tahoe) ç¯å¢ƒ
    runs-on: macos-26
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²ä»¥æ£€æµ‹ Tag

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

      - name: Sync and Checkout Latest Tag
        run: |
          # 1. æ·»åŠ ä¸Šæ¸¸ä»“åº“
          git remote add upstream https://github.com/buresdv/Cork.git || true
          git fetch upstream --tags
          
          # 2. è·å–æœ€æ–°çš„ç‰ˆæœ¬å· Tag (æ’é™¤ alpha/beta)
          # é€»è¾‘ï¼šåˆ—å‡ºæ‰€æœ‰ v å¼€å¤´çš„ tag -> æ’åº -> å–æœ€åä¸€ä¸ª
          LATEST_TAG=$(git tag -l "v*" | sort -V | tail -n 1)
          
          echo "ğŸ”¥ Detected latest stable version: $LATEST_TAG"
          
          # 3. å¼ºåˆ¶åˆ‡æ¢åˆ°è¿™ä¸ª Tag
          git checkout $LATEST_TAG
          
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸å†åˆå¹¶ mainï¼Œå› ä¸ºæˆ‘ä»¬è¦ç¼–è¯‘çš„æ˜¯çº¯å‡€çš„å‘å¸ƒç‰ˆ

      # --- ç¯å¢ƒå‡†å¤‡ ---
      
      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Generate Project with Tuist
        run: |
          # é’ˆå¯¹ Xcode 26 çš„å®‰å…¨ç­–ç•¥
          defaults write com.apple.dt.Xcode IDESkipPackagePluginFingerprintValidatation -bool YES
          
          tuist install
          # ä¿®æ”¹ç‚¹ï¼šæ·»åŠ ç¯å¢ƒå˜é‡ TUIST_SELF_COMPILED=1
          export TUIST_SELF_COMPILED=1
          tuist generate

# --- ç¼–è¯‘ä¸æ‰“åŒ… ---

      - name: Build Cork (Stable Release)
        run: |
          # ä¿®æ”¹ç‚¹ï¼š
          # 1. æ·»åŠ  -workspace Cork.xcworkspace (è§£å†³ä¾èµ–æŠ¥é”™)
          # 2. å°† -scheme Cork æ”¹ä¸º -scheme "Self-Compiled" (è§£å†³è®¸å¯è¯éªŒè¯)
          xcodebuild -workspace Cork.xcworkspace -scheme "Self-Compiled" -configuration Release -derivedDataPath build -destination 'platform=macOS,arch=arm64' clean build

      - name: Compress App
        run: |
          APP_PATH=$(find build -name "Cork.app" -type d | head -n 1)
          
          if [ -z "$APP_PATH" ]; then
            echo "âŒ Error: æœªæ‰¾åˆ° Cork.appï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥ï¼"
            exit 1
          fi
          
          echo "âœ… Found app at: $APP_PATH"
          
          # è·å–ç‰ˆæœ¬å·ä½œä¸ºæ–‡ä»¶åçš„ä¸€éƒ¨åˆ†
          VERSION_NAME=$(git describe --tags --abbrev=0)
          tar -czf "Cork-${VERSION_NAME}.tar.gz" -C "$(dirname "$APP_PATH")" Cork.app

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Cork-Stable-Build
          path: Cork-*.tar.gz
          retention-days: 90
